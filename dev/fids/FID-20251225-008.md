# FID-20251225-008: Dynamic Production Chain Visualization & Resource System Overhaul

**Status:** PENDING APPROVAL
**Priority:** H
**Complexity:** 5
**Created:** 2025-12-25
**Estimated:** 4-6h

---

## Overview

Implement a unified, scalable production chain visualization system for product and commodity pages, plus a comprehensive resource system overhaul including new resources (Iron Ore, Coal) and a new Heavy Industry sector.

---

## Scope

### Part A: New Resources & Heavy Industry Sector
1. Add **Iron Ore** resource (convert existing Steel in STATE_RESOURCES)
2. Add **Coal** resource (new, distributed to historic coal states)
3. Add **Heavy Industry** sector (production-only, no retail/service/extraction units)
4. Heavy Industry consumes: Iron Ore + Coal + Electricity → produces: Steel resource
5. Mining sector now extracts: Copper, Rare Earth, Iron Ore, Coal (NOT Steel)
6. Enforce extraction constraints: ALL sectors can only extract resources that exist in the state's STATE_RESOURCES

### Part B: Production Chain Visualization
1. Create unified `ProductionChainDiagram` component using React Flow
2. Shows sector + unit type breakdown (both levels)
3. Interactive nodes navigate to related pages
4. Dark mode aware styling
5. Placed above Supply/Demand section on product/commodity pages
6. Client-side computation from constants (no new API)

---

## Acceptance Criteria

### Part A: Resource System
- [ ] Iron Ore replaces Steel in STATE_RESOURCES with same distribution
- [ ] Coal added to STATE_RESOURCES for: WY, WV, PA, IL, KY, MT, IN, ND, TX, CO
- [ ] Heavy Industry sector added to SECTORS array
- [ ] Heavy Industry SECTOR_PRODUCTS = null (produces Steel resource, not a product)
- [ ] Heavy Industry SECTOR_RESOURCES = null (special case - consumes Iron Ore + Coal)
- [ ] Heavy Industry SECTOR_EXTRACTION = ['Steel'] (production units OUTPUT Steel)
- [ ] Heavy Industry cannot build retail, service units (only production units allowed)
- [ ] Mining SECTOR_EXTRACTION updated: ['Copper', 'Rare Earth', 'Iron Ore', 'Coal']
- [ ] BusinessUnitCalculator handles Heavy Industry special case (Iron Ore + Coal + Electricity consumption)
- [ ] Extraction validation enforces STATE_RESOURCES availability for ALL sectors

### Part B: Production Chain Diagram
- [ ] React Flow installed as dependency
- [ ] ProductionChainDiagram component created
- [ ] Supports type='product' | 'resource' prop
- [ ] Shows upstream (inputs) and downstream (outputs) connections
- [ ] Nodes show: Sector name + Unit type badges (Production/Retail/Service/Extraction)
- [ ] Clicking nodes navigates to /commodity/[name] or /product/[name]
- [ ] Dark mode aware theming using Tailwind variables
- [ ] Component integrated into product/[name]/page.tsx
- [ ] Component integrated into commodity/[name]/page.tsx
- [ ] Utility function: getProductionChainData(type, name) → returns nodes/edges
- [ ] TypeScript: 0 errors

---

## Technical Design

### New Constants Structure

```typescript
// sectors.ts modifications

// RESOURCES - Updated
export const RESOURCES = [
  'Oil',
  'Iron Ore',           // RENAMED from 'Steel'
  'Rare Earth',
  'Copper',
  'Fertile Land',
  'Lumber',
  'Chemical Compounds',
  'Coal',               // NEW
  'Steel',              // NOW a produced resource (from Heavy Industry extraction)
] as const;

// SECTORS - Add Heavy Industry
export const SECTORS = [
  'Technology',
  'Finance',
  'Healthcare',
  'Manufacturing',
  'Energy',
  'Retail',
  'Real Estate',
  'Transportation',
  'Media',
  'Telecommunications',
  'Agriculture',
  'Defense',
  'Hospitality',
  'Construction',
  'Pharmaceuticals',
  'Mining',
  'Heavy Industry',     // NEW - production-only sector
] as const;

// Heavy Industry special handling
export const SECTOR_PRODUCTS: Record<Sector, Product | null> = {
  // ... existing entries ...
  'Heavy Industry': null,  // Produces Steel resource via extraction, not a product
};

export const SECTOR_RESOURCES: Record<Sector, Resource | null> = {
  // ... existing entries ...
  // Update Manufacturing: 'Steel' → uses Steel (produced by Heavy Industry)
  'Manufacturing': 'Steel',  // Still consumes Steel
  'Heavy Industry': null,    // Special case - handled separately (multi-resource)
};

// NEW: Multi-resource consumption for Heavy Industry
export const HEAVY_INDUSTRY_INPUTS: Partial<Record<Resource, number>> = {
  'Iron Ore': 0.5,     // Units consumed per production unit per hour
  'Coal': 0.3,         // Units consumed per production unit per hour
};
export const HEAVY_INDUSTRY_ELECTRICITY_CONSUMPTION = 0.75;  // Higher than normal production

// Update SECTOR_EXTRACTION
export const SECTOR_EXTRACTION: Record<Sector, Resource[] | null> = {
  'Technology': null,
  'Finance': null,
  'Healthcare': null,
  'Manufacturing': null,     // CHANGED: No longer extracts Steel
  'Energy': ['Oil'],
  'Retail': null,
  'Real Estate': null,
  'Transportation': null,
  'Media': null,
  'Telecommunications': null,
  'Agriculture': ['Fertile Land', 'Lumber'],
  'Defense': null,
  'Hospitality': null,
  'Construction': ['Lumber'],
  'Pharmaceuticals': ['Chemical Compounds'],
  'Mining': ['Copper', 'Rare Earth', 'Iron Ore', 'Coal'],  // CHANGED: Removed Steel, added Iron Ore & Coal
  'Heavy Industry': ['Steel'],  // NEW: Extraction units OUTPUT Steel
};

// NEW: Sectors that can ONLY build production/extraction (no retail/service)
export const PRODUCTION_ONLY_SECTORS: Sector[] = ['Heavy Industry', 'Mining'];

// Update sector permission functions
export function sectorCanBuildRetail(sector: string): boolean {
  if (!isValidSector(sector)) return false;
  if (PRODUCTION_ONLY_SECTORS.includes(sector as Sector)) return false;
  const demands = SECTOR_RETAIL_DEMANDS[sector as Sector];
  return demands !== null && demands.length > 0;
}

export function sectorCanBuildService(sector: string): boolean {
  if (!isValidSector(sector)) return false;
  if (PRODUCTION_ONLY_SECTORS.includes(sector as Sector)) return false;
  const demands = SECTOR_SERVICE_DEMANDS[sector as Sector];
  return demands !== null && demands.length > 0;
}
```

### STATE_RESOURCES Updates

```typescript
// Convert all 'Steel' entries to 'Iron Ore' (same amounts)
// Add Coal to historic coal-producing states

export const STATE_RESOURCES: Record<string, StateResourcePool> = {
  // MIDWEST - Iron Range
  'MN': {
    'Iron Ore': 5000,     // Was Steel - Iron Range dominant source
    'Fertile Land': 5000,
    'Lumber': 400,
  },
  'MI': {
    'Iron Ore': 2000,     // Was Steel
    'Copper': 500,
    'Lumber': 600,
    'Fertile Land': 1200,
  },
  'WI': {
    'Iron Ore': 500,      // Was Steel
    'Lumber': 800,
    'Fertile Land': 1500,
  },
  // ... other states with Steel → Iron Ore conversion ...

  // COAL STATES (NEW additions)
  'WY': {
    'Oil': 500,
    'Chemical Compounds': 2000,
    'Rare Earth': 500,
    'Fertile Land': 400,
    'Coal': 8000,          // NEW - Largest US producer
  },
  'WV': {
    'Lumber': 500,
    'Chemical Compounds': 300,
    'Coal': 4000,          // NEW
  },
  'PA': {
    'Iron Ore': 200,       // Was Steel
    'Lumber': 400,
    'Chemical Compounds': 600,
    'Oil': 20,
    'Coal': 3000,          // NEW
  },
  'IL': {
    'Fertile Land': 7000,
    'Chemical Compounds': 500,
    'Iron Ore': 50,        // Was Steel
    'Coal': 2500,          // NEW
  },
  'KY': {
    'Fertile Land': 600,
    'Lumber': 400,
    'Chemical Compounds': 150,
    'Coal': 2000,          // NEW
  },
  'MT': {
    'Copper': 1000,
    'Lumber': 1500,
    'Oil': 80,
    'Rare Earth': 150,
    'Fertile Land': 1000,
    'Coal': 1500,          // NEW
  },
  'IN': {
    'Fertile Land': 4000,
    'Iron Ore': 30,        // Was Steel
    'Chemical Compounds': 200,
    'Coal': 1000,          // NEW
  },
  'ND': {
    'Oil': 1500,
    'Fertile Land': 2000,
    'Coal': 800,           // NEW
  },
  'TX': {
    'Oil': 5000,
    'Chemical Compounds': 8000,
    'Fertile Land': 3500,
    'Rare Earth': 300,
    'Iron Ore': 100,       // Was Steel
    'Coal': 600,           // NEW
  },
  'CO': {
    'Oil': 700,
    'Fertile Land': 800,
    'Coal': 500,           // NEW
  },
  // ... rest of states ...
};
```

### BusinessUnitCalculator Updates

```typescript
// Handle Heavy Industry special case in computeCommodityDemandByUnitType
computeCommodityDemandByUnitType(
  unitType: UnitType,
  sector: string,
  resource: string,
  unitCount: number
): number {
  if (unitCount <= 0) return 0;

  // Only production units consume raw resources
  if (unitType !== 'production') return 0;

  // SPECIAL CASE: Heavy Industry consumes Iron Ore + Coal
  if (sector === 'Heavy Industry') {
    const heavyInput = HEAVY_INDUSTRY_INPUTS[resource as Resource];
    if (heavyInput) {
      return unitCount * heavyInput;
    }
    return 0;
  }

  // Standard single resource consumption
  const requiredResource = (SECTOR_RESOURCES as Record<string, string | null>)[sector];
  if (requiredResource !== resource) return 0;

  return unitCount * PRODUCTION_RESOURCE_CONSUMPTION;
}

// Handle Heavy Industry electricity consumption
computeProductDemandByUnitType(
  unitType: UnitType,
  sector: string,
  product: string,
  unitCount: number
): number {
  // ... existing logic ...

  // Handle electricity for Heavy Industry
  if (product === 'Electricity' && unitType === 'production' && sector === 'Heavy Industry') {
    return unitCount * HEAVY_INDUSTRY_ELECTRICITY_CONSUMPTION;
  }

  // ... rest of logic ...
}

// Heavy Industry extraction units OUTPUT Steel
computeCommoditySupplyByUnitType(
  unitType: UnitType,
  sector: string,
  resource: string,
  unitCount: number
): number {
  if (unitCount <= 0) return 0;

  // Only extraction units supply resources
  if (unitType !== 'extraction') return 0;

  // Heavy Industry extraction outputs Steel
  if (sector === 'Heavy Industry' && resource === 'Steel') {
    return unitCount * EXTRACTION_OUTPUT_RATE;
  }

  // Standard extraction logic
  const extractable = (SECTOR_EXTRACTION as Record<string, string[] | null>)[sector];
  if (!extractable || !extractable.includes(resource)) return 0;

  return unitCount * this.getOutputRate('extraction');
}
```

### Extraction Validation (All Sectors)

```typescript
// NEW function in sectors.ts or a new validation file

/**
 * Validate extraction is allowed based on state resources
 * ALL sectors must have the resource available in the state
 */
export function canExtractInState(
  sector: string,
  stateCode: string,
  resource: Resource
): { allowed: boolean; reason?: string; available: number } {
  // Check if sector can extract this resource
  const extractable = SECTOR_EXTRACTION[sector as Sector];
  if (!extractable || !extractable.includes(resource)) {
    return {
      allowed: false,
      reason: `${sector} sector cannot extract ${resource}`,
      available: 0
    };
  }

  // Special case: Heavy Industry produces Steel, doesn't need it in ground
  if (sector === 'Heavy Industry' && resource === 'Steel') {
    return { allowed: true, available: Infinity };
  }

  // Check if state has this resource
  const stateAmount = getStateResourceAmount(stateCode, resource);
  if (stateAmount <= 0) {
    const stateName = getStateLabel(stateCode) || stateCode;
    return {
      allowed: false,
      reason: `${stateName} does not have ${resource} deposits`,
      available: 0
    };
  }

  return { allowed: true, available: stateAmount };
}

/**
 * Get all extractable resources for a sector in a specific state
 * Only returns resources that the state actually has
 */
export function getStateExtractableResources(
  sector: string,
  stateCode: string
): Resource[] {
  const sectorExtractable = SECTOR_EXTRACTION[sector as Sector];
  if (!sectorExtractable) return [];

  return sectorExtractable.filter(resource => {
    // Heavy Industry always can "extract" Steel (it produces it)
    if (sector === 'Heavy Industry' && resource === 'Steel') return true;
    return getStateResourceAmount(stateCode, resource as Resource) > 0;
  }) as Resource[];
}
```

### ProductionChainDiagram Component

```typescript
// frontend/lib/productionChain.ts

import { SECTOR_PRODUCTS, SECTOR_RESOURCES, SECTOR_EXTRACTION,
         SECTOR_PRODUCT_DEMANDS, SECTOR_RETAIL_DEMANDS, SECTOR_SERVICE_DEMANDS,
         HEAVY_INDUSTRY_INPUTS, type Sector, type Product, type Resource } from './constants';

export type ChainNodeType = 'resource' | 'product' | 'sector';
export type UnitTypeBadge = 'production' | 'retail' | 'service' | 'extraction';

export interface ChainNode {
  id: string;
  type: ChainNodeType;
  position: { x: number; y: number };
  data: {
    label: string;
    nodeType: ChainNodeType;
    unitTypes: UnitTypeBadge[];
    href?: string;
    color: string;
  };
}

export interface ChainEdge {
  id: string;
  source: string;
  target: string;
  animated?: boolean;
  style?: React.CSSProperties;
}

export interface ProductionChainData {
  nodes: ChainNode[];
  edges: ChainEdge[];
}

/**
 * Get production chain data for a product or resource
 */
export function getProductionChainData(
  type: 'product' | 'resource',
  name: string
): ProductionChainData {
  const nodes: ChainNode[] = [];
  const edges: ChainEdge[] = [];

  if (type === 'product') {
    return getProductChain(name as Product);
  } else {
    return getResourceChain(name as Resource);
  }
}

function getProductChain(product: Product): ProductionChainData {
  // ... implementation details ...
  // 1. Find sectors that PRODUCE this product → left side
  // 2. Find input resources for those sectors → far left
  // 3. Central node: the product itself
  // 4. Find sectors that DEMAND this product → right side (with unit type breakdown)
}

function getResourceChain(resource: Resource): ProductionChainData {
  // ... implementation details ...
  // 1. Find sectors that EXTRACT this resource → left side
  // 2. Central node: the resource itself
  // 3. Find sectors that CONSUME this resource → right side
  // 4. Find products those sectors produce → far right
}
```

```typescript
// frontend/components/ProductionChainDiagram.tsx

'use client';

import React, { useMemo } from 'react';
import ReactFlow, {
  Node,
  Edge,
  Background,
  Controls,
  MiniMap,
} from 'reactflow';
import 'reactflow/dist/style.css';
import { useRouter } from 'next/navigation';
import { getProductionChainData } from '@/lib/productionChain';
import ChainNode from './ChainNode';

const nodeTypes = {
  chainNode: ChainNode,
};

interface ProductionChainDiagramProps {
  type: 'product' | 'resource';
  name: string;
}

export default function ProductionChainDiagram({ type, name }: ProductionChainDiagramProps) {
  const router = useRouter();

  const { nodes, edges } = useMemo(() => {
    return getProductionChainData(type, name);
  }, [type, name]);

  const handleNodeClick = (event: React.MouseEvent, node: Node) => {
    if (node.data.href) {
      router.push(node.data.href);
    }
  };

  return (
    <div className="h-[300px] w-full rounded-2xl border border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-br from-white via-white to-gray-50/50 dark:from-gray-900 dark:via-gray-900 dark:to-gray-800/50 shadow-xl overflow-hidden">
      <ReactFlow
        nodes={nodes}
        edges={edges}
        nodeTypes={nodeTypes}
        onNodeClick={handleNodeClick}
        fitView
        proOptions={{ hideAttribution: true }}
      >
        <Background color="#e5e7eb" gap={16} className="dark:!bg-gray-800" />
        <Controls className="!bg-white dark:!bg-gray-800 !border-gray-200 dark:!border-gray-700" />
      </ReactFlow>
    </div>
  );
}
```

---

## File Changes

### Backend (Constants & Logic)
| File | Action | Description |
|------|--------|-------------|
| `backend/src/constants/sectors.ts` | MODIFY | Add Iron Ore, Coal, Heavy Industry. Update all mappings. Add extraction validation. |
| `backend/src/services/BusinessUnitCalculator.ts` | MODIFY | Handle Heavy Industry multi-resource consumption and Steel output |

### Frontend (Components & Utilities)
| File | Action | Description |
|------|--------|-------------|
| `frontend/package.json` | MODIFY | Add reactflow dependency |
| `frontend/lib/productionChain.ts` | CREATE | Utility functions for production chain data |
| `frontend/components/ProductionChainDiagram.tsx` | CREATE | React Flow based diagram component |
| `frontend/components/ChainNode.tsx` | CREATE | Custom node component for React Flow |
| `frontend/app/product/[name]/page.tsx` | MODIFY | Integrate ProductionChainDiagram above Supply/Demand |
| `frontend/app/commodity/[name]/page.tsx` | MODIFY | Integrate ProductionChainDiagram above Supply/Demand |

---

## Implementation Order (Tasks)

### Phase 1: Backend Resource System (Tasks 1-4)
1. **Task 1:** Update RESOURCES array - add Iron Ore, Coal, keep Steel as produced resource
2. **Task 2:** Update STATE_RESOURCES - convert Steel → Iron Ore, add Coal to coal states
3. **Task 3:** Add Heavy Industry to SECTORS and all sector mappings
4. **Task 4:** Add extraction validation function and PRODUCTION_ONLY_SECTORS

### Phase 2: Backend Logic (Tasks 5-6)
5. **Task 5:** Update BusinessUnitCalculator for Heavy Industry multi-resource consumption
6. **Task 6:** Update BusinessUnitCalculator for Steel output from Heavy Industry extraction

### Phase 3: Frontend Setup (Tasks 7-8)
7. **Task 7:** Install reactflow dependency
8. **Task 8:** Create productionChain.ts utility with getProductionChainData

### Phase 4: Frontend Components (Tasks 9-11)
9. **Task 9:** Create ChainNode.tsx custom node component
10. **Task 10:** Create ProductionChainDiagram.tsx main component
11. **Task 11:** Add dark mode styling and theming

### Phase 5: Integration (Tasks 12-14)
12. **Task 12:** Integrate ProductionChainDiagram into product/[name]/page.tsx
13. **Task 13:** Integrate ProductionChainDiagram into commodity/[name]/page.tsx
14. **Task 14:** TypeScript verification - 0 errors

---

## Visual Design

### Diagram Layout
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Production Chain Diagram                             │
│                                                                               │
│   [INPUT]              [CURRENT GOOD]                    [OUTPUT]             │
│                                                                               │
│  ┌─────────┐           ┌───────────────┐           ┌─────────────────────┐   │
│  │ Iron Ore│ ────────► │               │           │ Manufacturing       │   │
│  │ [Mining]│           │     STEEL     │ ────────► │ [Production] [Svc]  │   │
│  └─────────┘           │   (Resource)  │           └─────────────────────┘   │
│                        │               │                                      │
│  ┌─────────┐           │               │           ┌─────────────────────┐   │
│  │  Coal   │ ────────► │               │ ────────► │ Construction        │   │
│  │ [Mining]│           │               │           │ [Production]        │   │
│  └─────────┘           └───────────────┘           └─────────────────────┘   │
│                               ▲                                               │
│  ┌─────────────────────┐      │                    ┌─────────────────────┐   │
│  │ Heavy Industry      │ ─────┘                    │ Transportation      │   │
│  │ [Extraction]        │                           │ [Production]        │   │
│  └─────────────────────┘                           └─────────────────────┘   │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Node Styling
- **Resources**: Amber/Orange background (`bg-amber-100 dark:bg-amber-900/50`)
- **Products**: Indigo/Purple background (`bg-indigo-100 dark:bg-indigo-900/50`)
- **Sectors**: Gray background with colored unit type badges

### Unit Type Badges (inside sector nodes)
| Unit Type | Color | Example |
|-----------|-------|---------|
| Production | Blue | `bg-blue-500` |
| Retail | Green | `bg-green-500` |
| Service | Purple | `bg-purple-500` |
| Extraction | Orange | `bg-orange-500` |

### Dark Mode
- Background: Uses `dark:` variants
- Edges: Lighter gray in dark mode
- Text: High contrast white/gray

---

## Edge Cases

1. **Heavy Industry in states without Iron Ore/Coal**: Works fine - buys from market at current prices
2. **Mining in states without Iron Ore**: Cannot build extraction units for Iron Ore in that state
3. **Agriculture in states without Fertile Land**: Cannot build extraction units for Fertile Land
4. **Backwards compatibility**: Manufacturing still consumes "Steel" - now produced by Heavy Industry
5. **Electricity for Heavy Industry**: Uses higher HEAVY_INDUSTRY_ELECTRICITY_CONSUMPTION rate
6. **Steel as both input and output**: Manufacturing consumes Steel, Heavy Industry produces Steel

---

## Dependencies

- `reactflow` - npm package for diagram visualization (MIT license)
- Existing Tailwind classes for theming
- Existing sector constants for data

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Breaking existing Steel references | Steel remains as a resource - just produced by Heavy Industry instead of extracted |
| Heavy Industry special case complexity | Well-documented code with clear comments, isolated logic |
| React Flow bundle size | Use dynamic import for code splitting |
| State resource validation breaking existing extraction | This is intentional - prevents unrealistic extraction |
| UI too complex | Keep diagram simple, structural only, numbers in side panels |

---

## Summary of Key Changes

### Resources
| Before | After |
|--------|-------|
| Steel (extracted by Mining, Manufacturing) | Iron Ore (extracted by Mining) |
| N/A | Coal (extracted by Mining) |
| N/A | Steel (produced by Heavy Industry extraction) |

### Sectors
| Sector | Before | After |
|--------|--------|-------|
| Mining | Extracts Steel, Copper, Rare Earth | Extracts Iron Ore, Coal, Copper, Rare Earth |
| Manufacturing | Extracts Steel, consumes Steel | Consumes Steel only (no extraction) |
| Heavy Industry | N/A | NEW: Consumes Iron Ore + Coal + Electricity → Extracts Steel |

### Extraction Rules
| Before | After |
|--------|-------|
| No state validation | ALL extraction constrained by STATE_RESOURCES |

---

## Approval Checklist

Before proceeding, confirm these design decisions:

- [x] Iron Ore replaces Steel in STATE_RESOURCES (same distribution)
- [x] Coal added to: WY, WV, PA, IL, KY, MT, IN, ND, TX, CO
- [x] Heavy Industry sector is production-only (no retail/service)
- [x] Heavy Industry consumes Iron Ore + Coal + Electricity
- [x] Heavy Industry extraction units OUTPUT Steel
- [x] Mining extracts: Copper, Rare Earth, Iron Ore, Coal (NOT Steel)
- [x] Manufacturing no longer extracts (consumes Steel from Heavy Industry)
- [x] ALL extraction constrained by state resource availability
- [x] React Flow for interactive diagram
- [x] Single ProductionChainDiagram component for both pages
- [x] Click nodes to navigate
- [x] Dark mode aware theming
- [x] Diagram above Supply/Demand section
- [x] Client-side computation from constants (no new API)

---

**Ready for implementation upon user approval.**
