# FID-20251225-006: State Page Rework with Capacity Management

**Status:** PLANNED
**Priority:** H
**Complexity:** 4
**Created:** 2025-12-25
**Estimated:** 3h

## Description

Rework the states listing page to provide better regional organization, add sorting options for capacity and resource availability, implement backend capacity enforcement, and display capacity usage clearly on sector cards.

## Scope

### 1. Better Region Grouping
- Change regions to use more logical geographic groupings:
  - **West Coast**: CA, OR, WA, NV, AZ
  - **Mountain**: CO, UT, WY, MT, ID, NM
  - **Southwest**: TX, OK, AR, LA
  - **Midwest**: IL, IN, OH, MI, WI, MN, IA, MO, ND, SD, NE, KS
  - **Northeast**: NY, PA, NJ, MA, CT, RI, VT, NH, ME, DE, MD
  - **Southeast**: FL, GA, SC, NC, VA, WV, KY, TN, AL, MS
  - **Alaska & Hawaii**: AK, HI

### 2. State Capacity Sorting
- Add sort option for state capacity (High/Medium/Low)
- High capacity states: multiplier 4.0+ (15 units per sector)
- Medium capacity states: multiplier 2.0-3.9 (10-14 units per sector)
- Low capacity states: multiplier 1.0-1.9 (5-9 units per sector)
- Display capacity tier as badge

### 3. Resource Availability Sorting
- Add sort option showing states by extractable resources
- Display primary resources available in each state
- Show resource icons/badges for quick visual identification

### 4. Backend Capacity Enforcement
- Enforce maximum units per state based on multiplier
- Formula: `BASE_SECTOR_CAPACITY * state.multiplier` (BASE = 5)
- Cap existing corporations if they exceed capacity
- Return capacity info in state detail endpoint

### 5. Sector Card Capacity Display
- Show "X / Y units" where:
  - X = total units across all types in this sector
  - Y = capacity for this state
- If over capacity, display warning and cap at maximum

## Acceptance Criteria

- [ ] States grouped into new logical regions (7 total)
- [ ] Sort dropdown with options: Region (default), Capacity (High/Med/Low), Resources
- [ ] Capacity tier badges visible on state cards
- [ ] Resource badges showing what can be extracted in each state
- [ ] Backend enforces capacity limits on unit building
- [ ] Backend caps existing excessive units to capacity
- [ ] State detail endpoint returns capacity and current usage
- [ ] SectorCard displays "X / Y units used" for the specific state
- [ ] Warning displayed when at/over capacity
- [ ] TypeScript compiles with 0 errors

## Implementation Approach

### Phase 1: Backend - New Region Mapping & Capacity
1. Update US_REGIONS in sectors.ts with new region structure
2. Create capacity calculation utility function
3. Add capacity enforcement to build unit endpoint
4. Add capacity info to state detail endpoint response
5. Add migration/script to cap existing excessive units

### Phase 2: Backend - Resource Availability
1. Add endpoint to get states grouped by available resources
2. Enhance state metadata with extractable resources list

### Phase 3: Frontend - State Page UI
1. Update states page with new region structure
2. Add sort dropdown (Region/Capacity/Resources)
3. Implement sorting logic for each option
4. Add capacity tier badges to state cards
5. Add resource badges to state cards
6. Update TypeScript types for new data structure

### Phase 4: Frontend - Sector Card Capacity Display
1. Add capacity prop to SectorCard component
2. Calculate total units for the sector
3. Display "X / Y units" with visual indicator
4. Add warning when at/over capacity
5. Update parent pages to pass capacity data

### Phase 5: Testing & Verification
1. Test capacity enforcement on new builds
2. Verify existing units are capped appropriately
3. Test all sort options work correctly
4. Verify UI displays correctly across viewports
5. Run TypeScript verification

## Files to Create/Modify

### Backend
- `backend/src/constants/sectors.ts` (modify regions, add capacity utils)
- `backend/src/routes/markets.ts` (modify states endpoint, add capacity enforcement)
- `backend/src/utils/capacity.ts` (new - capacity calculation utilities)

### Frontend
- `frontend/app/states/page.tsx` (major rework - new regions, sorting, badges)
- `frontend/components/SectorCard.tsx` (add capacity display)
- `frontend/lib/api.ts` (update types for capacity data)
- `frontend/app/states/[code]/page.tsx` (pass capacity to SectorCard)
- `frontend/app/corporation/[id]/page.tsx` (pass capacity to SectorCard)

## Dependencies

- Existing state metadata in database
- Current SectorCard component
- Markets API endpoints

## Blockers

None

## Notes

- Capacity formula: `5 * multiplier` gives range of 5-20 units per sector
- Need to handle edge case where corporation already has more units than new capacity
- Resource badges should match commodity icons/colors from markets page
- Sort should be client-side for better UX (all data loaded at once)
