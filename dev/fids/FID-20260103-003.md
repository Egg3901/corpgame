# FID-20260103-003: Fully Configurable Business Unit Types

## Status: COMPLETED

## Goal
Enable full admin control over business unit types:
1. Toggle unit types (retail/production/service/extraction) on/off per sector
2. Any resource OR product can be input or output for ANY unit type
3. Clean admin UI with full dropdown selection

## Changes Made

### Phase 1: Fix Admin Panel Dropdowns
**File**: `components/admin/SectorConfigPanel.tsx`

Replaced hardcoded resource/product arrays with database data:
```typescript
// FID-20260103-003: Resource and product lists from database
const resourceNames = data?.resources?.map(r => r.resource_name) ?? [];
const productNames = data?.products?.map(p => p.product_name) ?? [];
const allCommodities = [...resourceNames, ...productNames];
```

This allows admins to select any resource or product as input/output for any unit type.

### Phase 2: Enforce `is_enabled` in Build Route
**File**: `app/api/markets/entries/[entryId]/build/route.ts`

Added database is_enabled check after existing hardcoded validation:
```typescript
// FID-20260103-003: Check database is_enabled flag for unit type
const sectorConfig = await SectorConfigService.getConfiguration();
const sectorUnitConfig = sectorConfig.sectors[marketEntry.sector_type]?.units?.[unit_type as UnitType];
if (sectorUnitConfig && !sectorUnitConfig.isEnabled) {
  return NextResponse.json({
    error: `${unit_type} units are disabled for ${marketEntry.sector_type} sector`
  }, { status: 400 });
}
```

### Phase 3: Update SectorCard Unit Visibility
**File**: `components/SectorCard.tsx`

Added new prop and updated show logic:
```typescript
unitEnabledStates?: Partial<Record<'retail' | 'production' | 'service' | 'extraction', boolean>>;

// FID-20260103-003: Respect unitEnabledStates from sector config
const showRetail = (unitEnabledStates?.retail !== false) && !isProductionOnly;
const showProduction = (unitEnabledStates?.production !== false) && !!producedProduct;
const showService = (unitEnabledStates?.service !== false) && !isProductionOnly;
const showExtraction = (unitEnabledStates?.extraction !== false) && canExtract;
```

### Phase 4: Pass Config to SectorCard
**Files**:
- `components/corporation/CorporationDashboard.tsx`
- `app/states/[code]/page.tsx`

Both files now extract unit enabled states from sector config and pass to SectorCard:
```typescript
// FID-20260103-003: Extract unit enabled states from sector config
const unitEnabledStates = sectorConfig ? {
  retail: sectorConfig.sectors[entry.sector_type]?.units?.retail?.isEnabled ?? true,
  production: sectorConfig.sectors[entry.sector_type]?.units?.production?.isEnabled ?? true,
  service: sectorConfig.sectors[entry.sector_type]?.units?.service?.isEnabled ?? true,
  extraction: sectorConfig.sectors[entry.sector_type]?.units?.extraction?.isEnabled ?? true,
} : undefined;
```

## Testing

1. **Toggle unit type off in admin**: Go to Admin > Sector Config, select a sector, toggle a unit type off, save. The unit type should disappear from SectorCard UI.

2. **Build disabled unit type via API**: Try to POST to `/api/markets/entries/:id/build` with a disabled unit type. Should receive 400 error.

3. **Add unusual input/output**: In admin panel, add "Oil" as production output for a non-Energy sector. Verify it appears in the dropdown and can be saved.

## Files Changed

| File | Description |
|------|-------------|
| `components/admin/SectorConfigPanel.tsx` | Use database resources/products for dropdowns |
| `app/api/markets/entries/[entryId]/build/route.ts` | Enforce is_enabled check |
| `components/SectorCard.tsx` | Add unitEnabledStates prop and visibility logic |
| `components/corporation/CorporationDashboard.tsx` | Pass unitEnabledStates to SectorCard |
| `app/states/[code]/page.tsx` | Pass unitEnabledStates to SectorCard |

## Notes

- Hardcoded defaults remain as fallbacks (isEnabled defaults to true)
- The `is_enabled` toggle is per-sector, not global
- Full I/O freedom allows extraction to output products, production to output resources, etc.
