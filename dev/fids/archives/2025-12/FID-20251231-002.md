# FID-20251231-001: Security Vulnerability Remediation

**Status:** IN_PROGRESS  
**Priority:** CRITICAL  
**Complexity:** 3  
**Created:** 2025-12-31  
**Started:** 2025-12-31  
**Estimated:** 2h  

## Summary

Fix all 7 security vulnerabilities identified in comprehensive security audit:
- 2 CRITICAL: JWT fallback secrets, file upload path traversal
- 2 HIGH: Weak rate limiting, missing bio sanitization  
- 2 MEDIUM: No password complexity, no granular admin permissions
- 1 LOW: Timing attack vulnerability

## Acceptance Criteria

- ✅ All CRITICAL vulnerabilities fixed (JWT, file uploads)
- ✅ All HIGH vulnerabilities fixed (rate limiting, XSS prevention)
- ✅ All MEDIUM vulnerabilities fixed (password complexity, admin RBAC)
- ✅ LOW vulnerability fixed (timing attacks)
- ✅ TypeScript: 0 errors
- ✅ Security validation tests pass

## Implementation Approach

### CRITICAL Fixes (Priority 1)
1. Remove JWT fallback secrets in `lib/auth/jwt.ts` - throw errors if env vars missing
2. Fix file upload path traversal in `app/api/avatar/route.ts` - use crypto.randomUUID()

### HIGH Fixes (Priority 2)
3. Implement proper rate limiting in `app/api/auth/login/route.ts` - use existing rate limit middleware
4. Add HTML sanitization to bio field in `lib/models/User.ts` - install isomorphic-dompurify, sanitize on input

### MEDIUM Fixes (Priority 3)
5. Add password complexity requirements in Zod validation schemas
6. Document admin permission limitations (defer full RBAC implementation)

### LOW Fixes (Priority 4)
7. Add constant-time comparison for login timing attacks

## Files to Modify

- **MOD** `lib/auth/jwt.ts` (126 lines) - Remove fallback secrets
- **MOD** `app/api/avatar/route.ts` (63 lines) - Fix path traversal
- **MOD** `app/api/auth/login/route.ts` (123 lines) - Implement proper rate limiting
- **MOD** `lib/models/User.ts` (359 lines) - Add bio sanitization
- **MOD** `lib/validations/auth.ts` (estimate ~100 lines) - Add password complexity
- **MOD** `package.json` - Add isomorphic-dompurify package

## Dependencies

None (all fixes are self-contained)

## Progress

- [ ] Task 1: Fix JWT fallback secrets (CRITICAL)
- [ ] Task 2: Fix file upload path traversal (CRITICAL)
- [ ] Task 3: Implement proper rate limiting (HIGH)
- [ ] Task 4: Add bio sanitization (HIGH)
- [ ] Task 5: Add password complexity (MEDIUM)
- [ ] Task 6: Add timing attack protection (LOW)
- [ ] Task 7: TypeScript verification
