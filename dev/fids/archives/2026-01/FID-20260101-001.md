# FID-20260101-001: Fix avatar upload 405 + standardize upload policy

**Status:** COMPLETED  
**Priority:** HIGH  
**Complexity:** 2  
**Created:** 2026-01-01  
**Started:** 2026-01-01  
**Completed:** 2026-01-01  
**Estimated:** 1h  

---

## Summary

Settings avatar upload was failing with HTTP `405` because the frontend posts to `/api/profile/avatar`, but that static route did not exist. The request was being captured by the dynamic `GET`-only route `/api/profile/[id]` (with `id="avatar"`), which returns `405` for `POST`.

This work adds a static `POST /api/profile/avatar` route that matches the client contract (`multipart/form-data` key `avatar`, response `{ profile_image_url }`) and standardizes image upload policy to **max 2MB** and **JPG/PNG/WEBP only**.

Additionally, an admin-only endpoint `GET /api/admin/users` was added to restore Admin UI compatibility.

---

## Acceptance Criteria

- ✅ `POST /api/profile/avatar` exists as a static App Router route and no longer hits `/api/profile/[id]`.
- ✅ Request contract:
  - ✅ Accepts `multipart/form-data` with `avatar` field.
  - ✅ Requires authorization (JWT bearer token).
- ✅ Validation policy:
  - ✅ Allowed MIME types: `image/jpeg`, `image/png`, `image/webp`.
  - ✅ Max size: 2MB.
- ✅ Response contract:
  - ✅ Returns `200` with `{ profile_image_url: string }`.
- ✅ Existing `/api/avatar` upload policy tightened to the same type/size rules.
- ✅ Admin UI users endpoint restored:
  - ✅ `GET /api/admin/users` returns an array compatible with the Admin UI.
- ✅ TypeScript check passes: `npx tsc --noEmit` → 0 errors.

---

## Implementation Notes

### Routes

- Added static avatar upload route to prevent dynamic route interception:
  - `app/api/profile/avatar/route.ts`
- Tightened global avatar upload endpoint validation:
  - `app/api/avatar/route.ts`
- Added admin-only users listing endpoint:
  - `app/api/admin/users/route.ts`

### Upload Policy (Standard)

- Max size: 2MB
- Allowed MIME types: `image/jpeg`, `image/png`, `image/webp`
- Filenames are UUID-based to avoid path traversal risks

---

## Verification

- ✅ TypeScript: `npx tsc --noEmit` (0 errors)

---

## Related Tracking

- Completion report: `docs/COMPLETION_REPORT_FID-20260101-001_20260101.md`
