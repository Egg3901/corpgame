# FID-20251225-001: Unified BusinessUnit Economics Calculator

**Status:** COMPLETED
**Priority:** HIGH
**Complexity:** 3/5
**Created:** 2025-12-25
**Estimated:** 2h

---

## Summary

Refactor sector demand/supply calculations from sector-based classes (ProductionSector, RetailServiceSector, ExtractionSector) to a unified BusinessUnit-based calculator.

### Problem
Currently, hybrid sectors like Defense (which has production, retail, AND service units) require duplicated logic across sector classes. Defense is classified as `ProductionSector` because it produces Defense Equipment, but its retail/service unit demands weren't being counted - leading to Defense Equipment showing zero demand on commodity pages.

### Solution
Create a unified `BusinessUnitCalculator` that computes economics based on **unit type** (production, retail, service, extraction) rather than sector classification.

---

## Acceptance Criteria

- [ ] Single `BusinessUnitCalculator` handles all unit type economics
- [ ] Each unit type uses its own consumption/output rates:
  - Production: PRODUCTION_*_CONSUMPTION rates
  - Retail: RETAIL_*_CONSUMPTION rates
  - Service: SERVICE_*_CONSUMPTION rates
  - Extraction: EXTRACTION_*_CONSUMPTION rates
- [ ] Sector-specific rules applied via config (SECTOR_RULES):
  - Defense: 1.0 consumption per unit (retail/service)
  - Manufacturing: 0.5 service consumption
- [ ] Defense Equipment shows correct demand from Defense retail/service units
- [ ] All commodity pages show accurate supply/demand
- [ ] TypeScript compiles with no errors
- [ ] Existing tests pass

---

## Approach

### Phase 1: Create BusinessUnitCalculator
1. Create `backend/src/services/BusinessUnitCalculator.ts`
2. Implement `computeProductDemand(unitType, sector, product, unitCount)`
3. Implement `computeProductSupply(unitType, sector, product, unitCount)`
4. Implement `computeCommodityDemand/Supply` methods
5. Add `SECTOR_RULES` config for sector-specific overrides

### Phase 2: Integrate with SectorCalculator
1. Update `SectorCalculator.computeProductSupplyDemand()` to use BusinessUnitCalculator
2. Update `SectorCalculator.computeCommoditySupplyDemand()` to use BusinessUnitCalculator
3. Remove sector class selection logic (no more ProductionSector vs RetailServiceSector distinction for calculations)

### Phase 3: Cleanup
1. Simplify or remove `ProductionSector.computeProductDemand()` duplication
2. Simplify or remove `RetailServiceSector.computeProductDemand()` duplication
3. Keep sector classes for any remaining sector-specific logic

### Phase 4: Verification
1. Verify Defense Equipment shows demand on commodity pages
2. Run TypeScript compilation
3. Run existing tests

---

## Files

| Action | File | Purpose |
|--------|------|---------|
| NEW | `backend/src/services/BusinessUnitCalculator.ts` | Unified economics calculator |
| MOD | `backend/src/services/SectorCalculator.ts` | Use BusinessUnitCalculator |
| MOD | `backend/src/domain/sectors/ProductionSector.ts` | Remove duplicated logic |
| MOD | `backend/src/domain/sectors/RetailServiceSector.ts` | Remove duplicated logic |
| MOD | `backend/src/constants/sectors.ts` | Add SECTOR_RULES config |

---

## Dependencies

None

---

## Notes

This refactor addresses the root cause of Defense Equipment showing zero demand - the sector classification system couldn't handle hybrid sectors that have multiple unit types with different demand configurations.
