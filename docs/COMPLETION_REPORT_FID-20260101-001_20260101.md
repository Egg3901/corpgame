# COMPLETION REPORT — FID-20260101-001

**Date:** 2026-01-01  
**Scope:** Avatar upload routing fix + upload policy standardization + admin users endpoint

---

## What Changed

### 1) Fixed Settings avatar upload `405`

- Root cause: the client posts to `/api/profile/avatar`, but without a static route, Next.js App Router matched `/api/profile/[id]` with `id="avatar"`. That dynamic route did not implement `POST`, so uploads returned `405`.
- Fix: added a static route handler at `POST /api/profile/avatar` so it takes precedence over the dynamic `[id]` route.

### 2) Standardized upload policy (avatar endpoints)

- Enforced **max 2MB** file size.
- Allowed MIME types: `image/jpeg`, `image/png`, `image/webp`.

### 3) Restored Admin UI user list

- Added an admin-only endpoint `GET /api/admin/users` returning an array shaped for the existing admin frontend.

---

## API Contract Notes

### `POST /api/profile/avatar`

- **Auth:** Required
- **Request:** `multipart/form-data` with field `avatar`
- **Response:** `{ "profile_image_url": string }`

---

## Files Created / Modified

- Added: `app/api/profile/avatar/route.ts`
- Added: `app/api/admin/users/route.ts`
- Modified: `app/api/avatar/route.ts`
- Modified: `app/api/profile/[id]/route.ts`

---

## Verification

- TypeScript: `npx tsc --noEmit` ✅ (0 errors)

---

## Lessons Learned

- In Next.js App Router, dynamic routes like `/api/profile/[id]` can unintentionally capture “static-looking” subpaths (e.g., `/avatar`) unless an explicit static route exists. For endpoints used by clients, prefer explicit static routes when the path is intended to be a fixed subresource.
